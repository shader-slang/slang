name: MaterialX Integration

on:
  pull_request:
    branches: [master]
    paths-ignore:
      - "docs/**"
      - "LICENSES/**"
      - "LICENSE"
      - "CONTRIBUTING.md"
      - "README.md"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Build jobs for each platform
  build-linux-release:
    uses: ./.github/workflows/ci-slang-build-container.yml
    with:
      config: release
      runs-on: '["ubuntu-22.04"]'

  build-windows-release:
    uses: ./.github/workflows/ci-slang-build.yml
    with:
      os: windows
      compiler: cl
      platform: x86_64
      config: release
      runs-on: '["windows-latest"]'
      build-llvm: false

  build-macos-release:
    uses: ./.github/workflows/ci-slang-build.yml
    with:
      os: macos
      compiler: clang
      platform: aarch64
      config: release
      runs-on: '["macos-latest"]'
      build-llvm: false

  # MaterialX test jobs that depend on builds
  test-materialx-linux:
    needs: [build-linux-release]
    uses: ./.github/workflows/materialx-test.yml
    with:
      os: linux
      compiler: gcc
      platform: x86_64
      config: release
      runs-on: '["ubuntu-22.04"]'

  test-materialx-windows:
    needs: [build-windows-release]
    uses: ./.github/workflows/materialx-test.yml
    with:
      os: windows
      compiler: cl
      platform: x86_64
      config: release
      runs-on: '["windows-latest"]'

  test-materialx-macos:
    needs: [build-macos-release]
    uses: ./.github/workflows/materialx-test.yml
    with:
      os: macos
      compiler: clang
      platform: aarch64
      config: release
      runs-on: '["macos-latest"]'

  # Summary job
  check-materialx-tests:
    needs: [test-materialx-linux, test-materialx-windows, test-materialx-macos]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check MaterialX Test Results
        run: |
          echo "=== MaterialX Integration Test Summary ==="
          echo "Linux: ${{ needs.test-materialx-linux.result }}"
          echo "Windows: ${{ needs.test-materialx-windows.result }}"
          echo "macOS: ${{ needs.test-materialx-macos.result }}"

          if [[ "${{ needs.test-materialx-linux.result }}" == "failure" ]] || \
             [[ "${{ needs.test-materialx-windows.result }}" == "failure" ]] || \
             [[ "${{ needs.test-materialx-macos.result }}" == "failure" ]]; then
            echo "One or more MaterialX tests failed"
            exit 1
          fi

          echo "All MaterialX tests passed!"
