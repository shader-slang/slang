name: RTX Remix Shaders (Nightly)

on:
  workflow_dispatch:
  schedule:
    # Run daily at 3 AM UTC (after coverage runs)
    - cron: "0 3 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read # Read slang repo
  issues: write # To create issues on failure (optional)

jobs:
  rtx-remix-shader-test:
    runs-on: windows-2022
    timeout-minutes: 45 # Slang build ~10-15 min + RTX Remix shaders ~10-15 min + buffer

    steps:
      - name: Checkout Slang repository
        uses: actions/checkout@v4
        with:
          submodules: "recursive"
          fetch-depth: 1 # Shallow clone for speed

      # Add bash to PATH on Windows (for consistency with main CI)
      - name: Add bash to PATH
        shell: pwsh
        run: |
          Add-Content -Path $env:GITHUB_PATH -Value "C:\\Program Files\\Git\\bin"
          Add-Content -Path $env:GITHUB_PATH -Value "C:\\Program Files\\Git\\usr\\bin"

      # Python 3.9+ required by Meson
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Meson build system
      - name: Install Meson
        run: pip install meson==1.9.1

      # Ninja should be pre-installed on windows-2022
      - name: Verify Ninja
        run: ninja --version

      # Set up MSVC environment (required even for Ninja builds on Windows)
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # Cache Slang build artifacts to speed up subsequent runs
      - name: Cache Slang build
        uses: actions/cache@v4
        with:
          path: |
            build/
          key: slang-build-${{ runner.os }}-${{ hashFiles('source/**', 'CMakeLists.txt', 'cmake/**') }}
          restore-keys: |
            slang-build-${{ runner.os }}-

      # Build Slang from checked-out source
      # Uses the same approach as CI: cmake --preset default + cmake --workflow --preset release
      - name: Build Slang
        run: |
          echo "Building Slang (Release)..."
          echo "CMake version: $(cmake --version | head -1)"

          startTime=$(date +%s)

          # Configure with default preset (Ninja Multi-Config)
          cmake --preset default --fresh -DSLANG_SLANG_LLVM_FLAVOR=DISABLE

          # Build using workflow preset (configure + build + package)
          cmake --workflow --preset release

          endTime=$(date +%s)
          duration=$(( (endTime - startTime) / 60 ))
          echo "Slang build completed in $duration minutes"

          # Verify slangc was built
          slangcPath="build/Release/bin/slangc.exe"
          if [ -f "$slangcPath" ]; then
            echo "✓ slangc built successfully at: $slangcPath"
            "$slangcPath" -version
          else
            echo "Failed to build slangc"
            exit 1
          fi

      # Clone dxvk-remix with all submodules (pinned to specific commit for stability)
      - name: Clone dxvk-remix repository
        run: |
          echo "Cloning dxvk-remix repository..."
          git clone --recursive --depth 1 https://github.com/NVIDIAGameWorks/dxvk-remix.git
          cd dxvk-remix
          commit=$(git rev-parse HEAD)
          echo "Using dxvk-remix commit: $commit"

      # Cache packman packages between runs to save ~2-5 minutes
      - name: Cache Packman packages
        uses: actions/cache@v4
        with:
          path: C:\packman-repo
          key: packman-${{ hashFiles('dxvk-remix/packman-external.xml') }}
          restore-keys: |
            packman-

      # Download shader compilation tools via packman
      # First run: ~2-5 min (downloads ~340MB)
      # Cached run: ~30 seconds
      - name: Download external dependencies (packman)
        run: |
          echo "Downloading packman dependencies..."
          cd dxvk-remix
          ./scripts-common/packman/packman.cmd pull packman-external.xml

      # Build shaders using build_shaders_only.ps1
      # This script handles both configuration and compilation
      - name: Build shaders using build_shaders_only.ps1
        run: |
          echo "Building RTX Remix shaders using build_shaders_only.ps1..."

          # Add our built Slang to PATH so dxvk-remix uses it instead of packman version
          slangBinPath="$(pwd)/build/Release/bin"
          echo "Adding Slang build to PATH: $slangBinPath"
          export PATH="$slangBinPath:$PATH"

          # Verify which slangc will be used
          whichSlangc=$(which slangc.exe 2>/dev/null || echo "not found")
          echo "Using slangc from: $whichSlangc"

          echo "Start time: $(date '+%H:%M:%S')"
          startTime=$(date +%s)

          cd dxvk-remix
          ./build_shaders_only.ps1

          exitCode=$?
          if [ $exitCode -ne 0 ]; then
            echo "RTX Remix shader build failed with exit code $exitCode"
            exit $exitCode
          fi

          endTime=$(date +%s)
          duration=$(( (endTime - startTime) / 60 ))
          echo "End time: $(date '+%H:%M:%S')"
          echo "Build duration: $duration minutes"

      # Verify build output
      - name: Verify shader compilation
        run: |
          echo "Verifying shader compilation output..."
          cd dxvk-remix/_BuildShadersOnly/src/dxvk/rtx_shaders

          headers=$(find . -maxdepth 1 -name "*.h" | wc -l)
          spvFiles=$(find . -maxdepth 1 -name "*.spv" | wc -l)
          totalSize=$(du -sm . | cut -f1)

          echo "Compiled shader headers (.h): $headers"
          echo "SPIR-V binary files (.spv): $spvFiles"
          echo "Total output size: $totalSize MB"

          # Validate minimum expected output (based on testing: 195 headers, 187 spv)
          if [ "$headers" -lt 100 ] || [ "$spvFiles" -lt 100 ]; then
            echo "Expected at least 100 shader files, but got $headers headers and $spvFiles .spv files"
            echo "This may indicate a shader compilation failure or incomplete build"
            exit 1
          fi

          echo ""
          echo "✓ RTX Remix shader compilation successful!"
          echo "  All $headers shader variants compiled correctly"

      # Upload build logs on failure for debugging
      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rtx-remix-shader-build-logs
          path: |
            dxvk-remix/_BuildShadersOnly/meson-logs/
          retention-days: 2

      # Report results
      - name: Report results
        if: always()
        run: |
          echo ""
          echo "================================================"
          if [ "$BUILD_RESULT" = "success" ]; then
            echo "✓ RTX Remix shader test PASSED"
            echo "  Slang compiler changes are compatible with RTX Remix shaders"
          else
            echo "✗ RTX Remix shader test FAILED"
            echo "  Slang compiler changes may have broken RTX Remix shader compilation"
            echo "  Review build logs for details"
          fi
          echo "================================================"
        env:
          BUILD_RESULT: ${{ job.status }}

      # Slack notification on failure (for scheduled runs only)
      - name: Failure notification
        id: slack-notify-failure
        if: ${{ github.event_name == 'schedule' && !success() }}
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "RTX-Remix-Nightly": ":alert: :alert: :alert: :alert: :alert: :alert:\nRTX Remix nightly status: ${{ job.status }}: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
