on:
  push:
    branches: [macos]
    # Sequence of patterns matched against refs/tags
    tags:
    - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10

name: MacOS Release

jobs:
  build_with_signing:
    name: Upload Release Asset
    runs-on: macos-latest
    strategy:
      matrix:
        configuration: ['release'] # 'debug'
        compiler: ['clang']
        platform: ['x64'] 
    steps:
      - name: "Import Certificate"
        uses: devbotsxyz/xcode-import-certificate@master
        with:
          certificate-data: "${{ secrets.BUILD_CERTIFICATE_BASE64 }}"
          certificate-passphrase: "${{ secrets.P12_PASSWORD }}"
          keychain-password: "${{ secrets.KEYCHAIN_PASSWORD }}"
      - name: Install the signing tools
        run: |
          brew install mitchellh/gon/gon
          security find-identity -v
          brew install coreutils
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          submodules: 'true'
          fetch-depth: '0'
      - name: Build release project
        id: build
        run: |
          echo "starting to build..."
          export CC=${{matrix.compiler}}
          export CONFIGURATION=${{matrix.configuration}}
          export ARCH=${{matrix.platform}}
          echo "building..."
          source ./github_macos_build.sh
      - name: Sign binaries
        env:
          KEY_PASSWORD: "${{ secrets.KEYCHAIN_PASSWORD }}"
          IDENTITY_ID: d6ada82a113e4204aaad914e1013e9548ffd30d0
        run: |
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k ${KEY_PASSWORD} build.keychain
          /usr/bin/codesign --force -s ${IDENTITY_ID} ./bin/macosx-x64/release/libslang.dylib -v
          /usr/bin/codesign --force -s ${IDENTITY_ID} ./bin/macosx-x64/release/slangd -v
          /usr/bin/codesign --force -s ${IDENTITY_ID} ./bin/macosx-x64/release/slangc -v
      - name: Package
        id: package
        run: |
          export SLANG_OS_NAME=macos
          export SLANG_ARCH_NAME=`uname -p`
          export TAG_NAME=`git describe --tags`
          export SLANG_TAG=${TAG_NAME#v}
          echo "tag:$TAG_NAME"
          echo "slang-tag:$SLANG_TAG"
          export SLANG_BINARY_ARCHIVE=slang-${SLANG_TAG}-${SLANG_OS_NAME}-${SLANG_ARCH_NAME}.zip
          echo "creating zip"
          7z a ${SLANG_BINARY_ARCHIVE} slang.h
          7z a ${SLANG_BINARY_ARCHIVE} slang-com-helper.h
          7z a ${SLANG_BINARY_ARCHIVE} slang-com-ptr.h
          7z a ${SLANG_BINARY_ARCHIVE} slang-tag-version.h
          7z a ${SLANG_BINARY_ARCHIVE} prelude/*.h
          7z a ${SLANG_BINARY_ARCHIVE} bin/*/*/libslang.dylib
          7z a ${SLANG_BINARY_ARCHIVE} bin/*/*/slangc
          7z a ${SLANG_BINARY_ARCHIVE} bin/*/*/slangd
          7z a ${SLANG_BINARY_ARCHIVE} docs/*.md
          echo "::set-output name=SLANG_BINARY_ARCHIVE::${SLANG_BINARY_ARCHIVE}"
      - name: UploadBinary
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.package.outputs.SLANG_BINARY_ARCHIVE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Notarize
        env:
          AC_PASSWORD: ${{secrets.APPLE_ID_PASSWORD}}
          BINARY_PATH: ${{ steps.package.outputs.SLANG_BINARY_ARCHIVE }}
        run: |
          timeout 1000 gon ./extras/macos-notarize.json
