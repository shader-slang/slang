name: CI Coverage Container Workflow

on:
  workflow_call:
    inputs:
      config:
        required: true
        type: string
      runs-on:
        required: true
        type: string
      server-count:
        required: false
        type: number
        default: 4
      deploy-pages:
        required: false
        type: boolean
        default: false

jobs:
  coverage-container:
    runs-on: ${{ fromJSON(inputs.runs-on) }}
    timeout-minutes: 180
    container:
      image: nvidia/cuda:12.4.1-devel-ubuntu22.04
      options: >-
        --gpus all
        --user root
        --device /dev/nvidia-modeset:/dev/nvidia-modeset
        --device /dev/dri:/dev/dri
        -e NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
        -v /etc/vulkan/icd.d/nvidia_icd.json:/etc/vulkan/icd.d/nvidia_icd.json:ro
        -v /usr/share/nvidia:/usr/share/nvidia:ro
        -v /usr/share/glvnd/egl_vendor.d/10_nvidia.json:/usr/share/glvnd/egl_vendor.d/10_nvidia.json:ro

    defaults:
      run:
        shell: bash

    steps:
      # Git must be installed before checkout for submodules to work in containers
      - name: Install Git and dependencies
        run: |
          apt-get update && apt-get install -y \
            git \
            build-essential \
            ninja-build \
            curl \
            unzip \
            python3 \
            libx11-dev \
            libxcursor-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libgl1-mesa-dev \
            libvulkan-dev \
            vulkan-validationlayers \
            spirv-tools \
            glslang-tools \
            wget \
            ca-certificates \
            libx11-6 \
            libxext6 \
            libegl1 \
            libvulkan1 \
            gnupg \
            lsb-release
          git config --global --add safe.directory '*'

      - uses: actions/checkout@v4
        with:
          submodules: "recursive"
          fetch-depth: "0"

      - name: Install Clang 18, LLVM Tools, and CMake
        run: |
          # Add LLVM APT repository
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -
          echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-18 main" > /etc/apt/sources.list.d/llvm.list
          apt-get update

          # Install clang-18 and LLVM coverage tools
          apt-get install -y clang-18 clang++-18 llvm-18

          # Create symlinks for coverage tools
          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
          update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100
          update-alternatives --install /usr/bin/llvm-profdata llvm-profdata /usr/bin/llvm-profdata-18 100
          update-alternatives --install /usr/bin/llvm-cov llvm-cov /usr/bin/llvm-cov-18 100

          # Verify installation
          echo "Clang version:"
          clang-18 --version
          echo "Clang++ version:"
          clang++-18 --version
          echo "llvm-profdata version:"
          llvm-profdata --version
          echo "llvm-cov version:"
          llvm-cov --version

          # Install CMake 3.30 (required for CMakePresets.json version 6)
          wget -q https://github.com/Kitware/CMake/releases/download/v3.30.0/cmake-3.30.0-linux-x86_64.tar.gz
          tar -xzf cmake-3.30.0-linux-x86_64.tar.gz -C /opt
          rm cmake-3.30.0-linux-x86_64.tar.gz
          ln -s /opt/cmake-3.30.0-linux-x86_64/bin/cmake /usr/local/bin/cmake
          ln -s /opt/cmake-3.30.0-linux-x86_64/bin/ctest /usr/local/bin/ctest
          ln -s /opt/cmake-3.30.0-linux-x86_64/bin/cpack /usr/local/bin/cpack

          echo "CMake version:"
          cmake --version
          echo "CUDA version:"
          nvcc --version

      - name: Build Slang with Coverage and CUDA
        run: |
          echo "Building with coverage instrumentation + CUDA support"

          # Set compilers
          export CC=clang-18
          export CXX=clang++-18

          # Configure with coverage preset + CUDA
          cmake --preset coverage --fresh \
            -DSLANG_ENABLE_CUDA=ON \
            -DSLANG_SLANG_LLVM_FLAVOR=DISABLE

          # Build
          cmake --build --preset coverage -j$(nproc)

          # Verify CUDA support
          if ldd build/RelWithDebInfo/lib/librender-test-tool.so 2>/dev/null | grep -q cuda; then
            echo "✅ render-test-tool has CUDA support!"
          else
            echo "⚠️  render-test-tool may not have CUDA linked"
            ldd build/RelWithDebInfo/lib/librender-test-tool.so 2>/dev/null || true
          fi

      - name: Run Tests with Coverage
        run: |
          # Generate both HTML and LCOV formats
          export COVERAGE_HTML=1
          export COVERAGE_LCOV=1
          export COVERAGE_HTML_DIR="$PWD/coverage-html"
          export COVERAGE_LCOV_FILE="$PWD/coverage.lcov"

          # Set SPIRV validation environment variables
          export SLANG_RUN_SPIRV_VALIDATION=1
          export SLANG_USE_SPV_SOURCE_LANGUAGE_UNKNOWN=1

          # Build slang-test arguments for GPU testing
          test_args=(
            "-category" "full"
            "-expected-failure-list" "tests/expected-failure-github.txt"
            "-expected-failure-list" "tests/expected-failure-linux-gpu.txt"
            "-skip-reference-image-generation"
            "-show-adapter-info"
            "-ignore-abort-msg"
            "-enable-debug-layers" "true"
          )

          # Add test server arguments if server count > 1
          if [ "${{ inputs.server-count }}" -gt 1 ]; then
            test_args+=("-use-test-server")
            test_args+=("-server-count" "${{ inputs.server-count }}")
          fi

          # Verify GPU is accessible
          echo "=== GPU Info ==="
          nvidia-smi

          # Check CUDA
          echo "=== CUDA libraries ==="
          ldconfig -p | grep -i cuda || echo "No CUDA libraries in ldconfig"

          # Run coverage with GPU test suite
          ./tools/coverage/run-coverage.sh "${test_args[@]}"

      - name: Generate Coverage Summary
        id: coverage-summary
        run: |
          # Extract all coverage metrics from llvm-cov report output
          BUILD_DIR="${BUILD_DIR:-build}"
          CONFIG="${CONFIG:-RelWithDebInfo}"
          COVERAGE_DIR="${COVERAGE_DIR:-$BUILD_DIR/coverage-data}"

          LLVM_COV="${LLVM_COV:-llvm-cov}"
          LIB_EXT="so"
          LIBSLANG="$BUILD_DIR/$CONFIG/lib/libslang.$LIB_EXT"

          # Generate machine-readable coverage report
          REPORT_OUTPUT=$($LLVM_COV report "$LIBSLANG" -instr-profile="$COVERAGE_DIR/slang-test.profdata" 2>/dev/null || echo "")

          if [[ -n "$REPORT_OUTPUT" ]]; then
            # Extract TOTALS line which contains all metrics
            TOTALS_LINE=$(echo "$REPORT_OUTPUT" | grep "^TOTAL" | head -1)

            if [[ -n "$TOTALS_LINE" ]]; then
              # Parse the TOTALS line
              read -r _ regions_hit regions_total region_pct functions_hit functions_total function_pct lines_hit lines_total line_pct branches_hit branches_total branch_pct <<< "$TOTALS_LINE"

              # Output for GitHub Actions
              echo "coverage=$line_pct" >> $GITHUB_OUTPUT

              # Generate step summary
              cat >> $GITHUB_STEP_SUMMARY <<EOF
          # Coverage Report (Linux GPU)
          - **Line Coverage:** ${line_pct}% (${lines_hit} / ${lines_total})
          - **Region Coverage:** ${region_pct}% (${regions_hit} / ${regions_total})
          - **Function Coverage:** ${function_pct}% (${functions_hit} / ${functions_total})
          - **Branch Coverage:** ${branch_pct}% (${branches_hit} / ${branches_total})
          EOF

              # Save coverage summary with GPU platform label
              REPORT_DATE=$(date -u +"%Y-%m-%d")
              COMMIT_SHORT=$(git rev-parse --short HEAD)
              cat > coverage-summary.json <<EOF
          {
            "date": "${REPORT_DATE}",
            "commit": "${COMMIT_SHORT}",
            "platform": "linux-gpu",
            "platform_detail": "linux-gpu-x86_64",
            "line_coverage": "${line_pct}",
            "lines_hit": ${lines_hit},
            "lines_found": ${lines_total},
            "region_coverage": "${region_pct}",
            "regions_hit": ${regions_hit},
            "regions_found": ${regions_total},
            "function_coverage": "${function_pct}",
            "functions_hit": ${functions_hit},
            "functions_found": ${functions_total},
            "branch_coverage": "${branch_pct}",
            "branches_hit": ${branches_hit},
            "branches_found": ${branches_total}
          }
          EOF
              echo "Saved coverage summary to coverage-summary.json"
              cat coverage-summary.json
            else
              echo "Error: Could not parse TOTALS line from llvm-cov report"
              exit 1
            fi
          else
            echo "Error: Failed to generate llvm-cov report"
            exit 1
          fi

      - name: Upload Coverage Artifacts for Merging
        if: ${{ !inputs.deploy-pages }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-linux-gpu-x86_64
          path: |
            coverage-summary.json
            coverage-html/
            build/RelWithDebInfo/coverage-data/slang-test.profdata
            build/RelWithDebInfo/lib/libslang.so
          retention-days: 7

      # Direct deployment not implemented in this workflow
      # The nightly workflow merges artifacts and deploys
