name: RTX Remix Integration Tests

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
      compiler:
        required: true
        type: string
      platform:
        required: true
        type: string
      config:
        required: true
        type: string
      runs-on:
        required: true
        type: string

jobs:
  rtx-remix-integration:
    runs-on: ${{ fromJSON(inputs.runs-on) }}
    timeout-minutes: 30 # RTX Remix shaders ~15-20 min + buffer
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: "recursive"
          fetch-depth: "1"

      - name: Download Slang Artifacts
        uses: actions/download-artifact@v4
        with:
          name: slang-tests-${{ inputs.os }}-${{ inputs.platform }}-${{ inputs.compiler }}-${{ inputs.config }}
          path: github_artifact

      - name: Setup Slang Path
        run: |
          # Set up bin_dir for slangc (Windows only)
          bin_dir="$(pwd)/github_artifact/Release/bin"
          SLANGC="${bin_dir}/slangc.exe"

          echo "bin_dir=$bin_dir" >> $GITHUB_ENV
          echo "SLANGC=$SLANGC" >> $GITHUB_ENV

          # Verify slangc exists and is executable
          if [ ! -f "$SLANGC" ]; then
            echo "ERROR: slangc not found at: $SLANGC"
            echo "Artifact directory contents:"
            ls -laR github_artifact/ || true
            exit 1
          fi

          echo "Found slangc at: $SLANGC"
          "$SLANGC" --version || echo "Could not get slangc version"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Meson
        run: pip install meson==1.9.1

      - name: Verify Ninja
        run: ninja --version

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Clone dxvk-remix repository
        run: |
          echo "===================================================================="
          echo "RTX Remix â†’ Slang Integration Test"
          echo "Platform: ${{ inputs.os }} | Config: ${{ inputs.config }}"
          echo "===================================================================="

          WORK_DIR="${RUNNER_TEMP}/rtx-remix-test"
          mkdir -p "$WORK_DIR"
          cd "$WORK_DIR"

          echo "Cloning dxvk-remix repository (tag: remix-1.3.5)..."
          git clone --recursive --depth 1 --branch remix-1.3.5 https://github.com/NVIDIAGameWorks/dxvk-remix.git
          cd dxvk-remix
          commit=$(git rev-parse HEAD)
          tag=$(git describe --tags --exact-match 2>/dev/null || echo "no tag")
          echo "Using dxvk-remix commit: $commit"
          echo "Tag: $tag"

      - name: Cache Packman packages
        uses: actions/cache@v4
        with:
          path: C:\packman-repo
          key: packman-${{ hashFiles(format('{0}/rtx-remix-test/dxvk-remix/packman-external.xml', runner.temp)) }}
          restore-keys: |
            packman-
          enableCrossOsArchive: false

      - name: Download external dependencies (packman)
        run: |
          WORK_DIR="${RUNNER_TEMP}/rtx-remix-test"
          cd "$WORK_DIR/dxvk-remix"

          echo "Downloading packman dependencies..."
          ./scripts-common/packman/packman.cmd pull packman-external.xml

      - name: Replace packman Slang binaries with built version
        run: |
          WORK_DIR="${RUNNER_TEMP}/rtx-remix-test"
          cd "$WORK_DIR/dxvk-remix"

          echo "Replacing packman Slang binaries with locally built version..."

          remixSlangDir="external/slang"

          if [ ! -d "$remixSlangDir" ]; then
            echo "ERROR: Packman Slang directory not found at: $remixSlangDir"
            exit 1
          fi

          echo "Found packman Slang at: $remixSlangDir"

          # Show original version
          originalSlangc="$remixSlangDir/slangc.exe"
          if [ -f "$originalSlangc" ]; then
            echo ""
            echo "Original packman slangc version:"
            "$originalSlangc" -version || echo "Could not get version"
          fi

          # Copy our built Slang binaries
          echo ""
          echo "Copying Slang binaries from artifact..."
          cp -rf "$bin_dir"/* "$remixSlangDir/"

          # Verify replacement succeeded
          echo ""
          echo "Verifying replacement..."

          requiredFiles=("slangc.exe" "slang-compiler.dll" "slang-glslang.dll")

          for file in "${requiredFiles[@]}"; do
            filePath="$remixSlangDir/$file"
            if [ ! -f "$filePath" ]; then
              echo "ERROR: Required file not found after copy: $file"
              exit 1
            fi
          done

          # List all copied Slang files for verification
          echo ""
          echo "Copied Slang files:"
          ls -la "$remixSlangDir"/slang* || true

          # Verify version changed
          newSlangc="$remixSlangDir/slangc.exe"
          newVersion=$("$newSlangc" -version 2>&1 || echo "version-check-failed")
          echo "New slangc version:"
          echo "$newVersion"

          echo ""
          echo "Verified: dxvk-remix will use the locally built Slang"

      - name: Build shaders using build_shaders_only.ps1
        shell: pwsh
        env:
          SLANG_RUN_SPIRV_VALIDATION: 1
          SLANG_USE_SPV_SOURCE_LANGUAGE_UNKNOWN: 1
        run: |
          $ErrorActionPreference = 'Stop'
          $WORK_DIR = "$env:RUNNER_TEMP/rtx-remix-test"
          Set-Location "$WORK_DIR/dxvk-remix"

          Write-Host "Building RTX Remix shaders..."
          Write-Host "SPIRV validation enabled via SLANG_RUN_SPIRV_VALIDATION=1"
          Write-Host "Start time: $(Get-Date -Format 'HH:mm:ss')"

          $startTime = Get-Date

          # Remove Git's usr\bin from PATH to avoid GNU link.exe conflict with MSVC link.exe
          # Keep Git\bin and Git\mingw64\bin for git and bash commands
          $env:PATH = ($env:PATH -split ';' | Where-Object {
            $_ -notmatch '\\Git\\usr\\bin$'
          }) -join ';'

          Write-Host "Running build_shaders_only.ps1..."

          # Capture output to check for build failures
          # build_shaders_only.ps1 doesn't always return proper exit codes
          $buildOutput = & .\build_shaders_only.ps1 2>&1 | Tee-Object -Variable output
          $buildExitCode = $LASTEXITCODE

          $duration = (Get-Date) - $startTime
          Write-Host "End time: $(Get-Date -Format 'HH:mm:ss')"
          Write-Host "Build duration: $($duration.TotalMinutes.ToString('0.00')) minutes"

          # Check for build failures in output (build_shaders_only.ps1 may not return error codes properly)
          $outputString = $output -join "`n"
          $hasFailed = $outputString -match "FAILED:|ninja: build stopped|meson.build.*ERROR:"
          $hasError = $outputString -match "error \d+:"

          if ($buildExitCode -ne 0) {
            Write-Host ""
            Write-Host "ERROR: build_shaders_only.ps1 returned exit code $buildExitCode"
            exit 1
          }

          if ($hasFailed) {
            Write-Host ""
            Write-Host "ERROR: Build output contains failure indicators"
            Write-Host "Detected: ninja/meson build failures"
            Write-Host ""
            Write-Host "Build failed even though script returned success exit code"
            exit 1
          }

          if ($hasError) {
            Write-Host ""
            Write-Host "ERROR: Build output contains compilation errors"
            Write-Host "Shader compilation errors detected in build log"
            Write-Host ""
            Write-Host "Review the slangc output above for details"
            exit 1
          }

          Write-Host ""
          Write-Host "Build completed successfully"

      - name: Verify shader compilation
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $WORK_DIR = "$env:RUNNER_TEMP/rtx-remix-test"
          Set-Location "$WORK_DIR/dxvk-remix"

          Write-Host "Verifying shader compilation output..."

          # Find the build output directory
          $possibleDirs = @(
            "_BuildShadersOnly/src/dxvk/rtx_shaders",
            "_BuildRelease/src/dxvk/rtx_shaders"
          )

          $shaderDir = $null
          foreach ($dir in $possibleDirs) {
            if (Test-Path $dir) {
              $shaderDir = $dir
              break
            }
          }

          if (-not $shaderDir) {
            Write-Host "ERROR: Cannot find shader output directory"
            Write-Host "Expected one of:"
            foreach ($dir in $possibleDirs) {
              Write-Host "  - $dir"
            }
            Write-Host ""
            Write-Host "Searching for rtx_shaders directories:"
            Get-ChildItem -Path . -Filter "rtx_shaders" -Directory -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  Found: $($_.FullName)"
            }

            # Check if build directory exists at all
            if (-not (Test-Path "_BuildShadersOnly")) {
              Write-Host ""
              Write-Host "ERROR: Build directory _BuildShadersOnly does not exist"
              Write-Host "This indicates the Meson configuration or build step failed"
              Write-Host "Check the build logs above for Meson errors (e.g., PATH issues, missing dependencies)"
            }

            exit 1
          }

          Write-Host "Found shader directory: $shaderDir"
          Set-Location $shaderDir

          # Count generated files
          $headers = (Get-ChildItem -Filter "*.h" -File | Measure-Object).Count
          $spvFiles = (Get-ChildItem -Filter "*.spv" -File | Measure-Object).Count
          $totalSizeMB = [math]::Round((Get-ChildItem -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB, 2)

          Write-Host "Compiled shader headers (.h): $headers"
          Write-Host "SPIR-V binary files (.spv): $spvFiles"
          Write-Host "Total output size: $totalSizeMB MB"

          # Validate that shaders were actually generated
          if ($headers -eq 0 -or $spvFiles -eq 0) {
            Write-Host ""
            Write-Host "ERROR: No shader files generated"
            Write-Host "This indicates shader compilation failed completely"
            exit 1
          }

          # Sanity check: RTX Remix should have at least 100 shaders
          if ($headers -lt 100 -or $spvFiles -lt 100) {
            Write-Host ""
            Write-Host "ERROR: Unexpectedly low shader count: $headers headers, $spvFiles .spv files"
            Write-Host "Expected at least 100 shaders - this may indicate a partial build failure"
            exit 1
          }

          Write-Host ""
          Write-Host "===================================================================="
          Write-Host "RTX Remix shader compilation successful!"
          Write-Host "All $headers shader variants compiled correctly"
          Write-Host "===================================================================="

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rtx-remix-build-logs-${{ inputs.os }}-${{ inputs.config }}
          path: |
            ${{ runner.temp }}/rtx-remix-test/dxvk-remix/_BuildShadersOnly/meson-logs/
            ${{ runner.temp }}/rtx-remix-test/dxvk-remix/_BuildRelease/meson-logs/
          retention-days: 2
