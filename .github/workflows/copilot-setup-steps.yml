name: "Copilot Setup Steps"

on:
  workflow_dispatch:
  # Automatically run the setup steps when they are changed to allow for easy validation, and
  # allow manual testing through the repository's "Actions" tab
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    # Use self-hosted ARC runner with GPU support for Copilot
    runs-on: [self-hosted, Linux, GPU, arc]

    permissions:
      contents: read
      pull-requests: write
      checks: write

    container:
      image: nvidia/cuda:12.4.1-devel-ubuntu22.04
      options: >-
        --gpus all
        --user root
        --device /dev/nvidia-modeset:/dev/nvidia-modeset
        --device /dev/dri:/dev/dri
        -e NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
        -v /etc/vulkan/icd.d/nvidia_icd.json:/etc/vulkan/icd.d/nvidia_icd.json:ro
        -v /usr/share/nvidia:/usr/share/nvidia:ro
        -v /usr/share/glvnd/egl_vendor.d/10_nvidia.json:/usr/share/glvnd/egl_vendor.d/10_nvidia.json:ro

    defaults:
      run:
        shell: bash

    steps:
      - name: Install Git
        run: |
          apt-get update && apt-get install -y git
          git --version
          git config --global --add safe.directory '*'

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 2

      - name: Install build dependencies
        run: |
          apt-get update && apt-get install -y \
            build-essential \
            ninja-build \
            curl \
            unzip \
            python3 \
            libx11-dev \
            libxcursor-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libgl1-mesa-dev \
            libvulkan-dev \
            vulkan-validationlayers \
            spirv-tools \
            glslang-tools \
            wget \
            ca-certificates
          rm -rf /var/lib/apt/lists/*

          # Install CMake 3.30 (required for CMakePresets.json version 6)
          wget -q https://github.com/Kitware/CMake/releases/download/v3.30.0/cmake-3.30.0-linux-x86_64.tar.gz
          tar -xzf cmake-3.30.0-linux-x86_64.tar.gz -C /opt
          rm cmake-3.30.0-linux-x86_64.tar.gz
          ln -s /opt/cmake-3.30.0-linux-x86_64/bin/cmake /usr/local/bin/cmake
          ln -s /opt/cmake-3.30.0-linux-x86_64/bin/ctest /usr/local/bin/ctest
          ln -s /opt/cmake-3.30.0-linux-x86_64/bin/cpack /usr/local/bin/cpack

      - name: Verify GPU access
        run: |
          echo "=== GPU Information ==="
          nvidia-smi
          echo "=== CMake version ==="
          cmake --version
          echo "=== CUDA version ==="
          nvcc --version

      - name: Configure CMake
        run: |
          cmake --preset default --fresh \
            -DSLANG_ENABLE_CUDA=ON \
            -DSLANG_SLANG_LLVM_FLAVOR=DISABLE

      - name: Build Slang
        run: |
          cmake --build --preset debug -j$(nproc)
