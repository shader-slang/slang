name: "Copilot Setup Steps"

on:
  workflow_dispatch:
  # Automatically run the setup steps when they are changed to allow for easy validation, and
  # allow manual testing through the repository's "Actions" tab
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    # Use GitHub larger runner with GPU support for Copilot
    # TESTING: Container with Copilot workaround from https://github.com/orgs/community/discussions/170315
    # Workaround: Mount /home/runner to resolve hardcoded paths
    runs-on: slang-larger-runner-1

    permissions:
      contents: read
      pull-requests: write
      checks: write
      packages: read

    # Testing container approach with Copilot workaround
    # Uses existing GPU CI container image with all prerequisites pre-installed
    container:
      image: ghcr.io/shader-slang/slang-linux-gpu-ci:v1.3.0
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: >-
        --gpus all
        --user root
        --device /dev/nvidia-modeset:/dev/nvidia-modeset
        --device /dev/dri:/dev/dri
        -e NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
        -v /etc/vulkan/icd.d/nvidia_icd.json:/etc/vulkan/icd.d/nvidia_icd.json:ro
        -v /usr/share/nvidia:/usr/share/nvidia:ro
        -v /usr/share/glvnd/egl_vendor.d/10_nvidia.json:/usr/share/glvnd/egl_vendor.d/10_nvidia.json:ro
        -v /home/runner:/home/runner
        --cap-add=NET_ADMIN
        --cap-add=NET_RAW

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 2

      - name: Verify container environment
        run: |
          echo "=== Container Environment ==="
          echo "Working directory: $(pwd)"
          echo "User: $(whoami)"
          echo "Home: $HOME"
          echo ""
          echo "=== Pre-installed Tools (from container image) ==="
          print-env-info
          echo ""
          echo "CMake: $(cmake --version | head -1)"
          echo "gcc: $(gcc --version | head -1)"
          echo "ninja: $(ninja --version)"
          echo ""
          echo "=== Copilot Workaround Path Check ==="
          echo "Host runner path exists: $(test -d /home/runner && echo 'YES' || echo 'NO')"
          if [ -d /home/runner ]; then
            echo "Contents of /home/runner:"
            ls -la /home/runner/ 2>/dev/null | head -10
          else
            echo "WARNING: /home/runner not accessible - Copilot may fail"
          fi

      - name: Verify GPU access
        run: |
          echo "=== GPU Information ==="
          nvidia-smi
          echo "=== CUDA version ==="
          nvcc --version

      - name: Configure CMake
        run: |
          cmake --preset default --fresh \
            -DSLANG_ENABLE_CUDA=ON \
            -DSLANG_SLANG_LLVM_FLAVOR=DISABLE

      - name: Build Slang
        run: |
          cmake --build --preset debug -j$(nproc)

      - name: Test summary
        if: always()
        run: |
          echo "=== Container Test Result Summary ==="
          echo "Container with Copilot workaround test completed"
          echo ""
          if [ -f build/Debug/bin/slangc ]; then
            echo "✓ Build successful: slangc binary exists"
            ls -lh build/Debug/bin/slangc
          else
            echo "✗ Build failed: slangc binary not found"
          fi
