name: "Copilot Setup Steps"

on:
  workflow_dispatch:
  # Automatically run the setup steps when they are changed to allow for easy validation, and
  # allow manual testing through the repository's "Actions" tab
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    # Use GitHub larger runner with GPU support for Copilot
    # Avoids path mapping issues with ARC runners (/runner vs /home/runner)
    runs-on: slang-larger-runner-1

    permissions:
      contents: read
      pull-requests: write
      checks: write

    # No container - Copilot does not support containers
    # Known issue: https://github.com/orgs/community/discussions/170315
    # Run directly on larger runner which has full toolchain

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 2

      - name: Verify GPU access
        run: |
          echo "=== GPU Information ==="
          nvidia-smi
          echo "=== CMake version ==="
          cmake --version
          echo "=== CUDA version ==="
          nvcc --version

      - name: Configure CMake
        run: |
          cmake --preset default --fresh \
            -DSLANG_ENABLE_CUDA=ON \
            -DSLANG_SLANG_LLVM_FLAVOR=DISABLE

      - name: Build Slang
        run: |
          cmake --build --preset debug -j$(nproc)
