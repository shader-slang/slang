name: Claude CI Failure Analysis

# Analyzes CI failures on PRs, fixes the code, and pushes the fix
# Triggers when the main CI workflow completes with failure
# Based on: claude-code-action/examples/ci-failure-auto-fix.yml
#
# Flow: CI fails on PR -> grab error logs -> create fix branch -> Claude fixes -> merge back to PR branch

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: "Failed CI workflow run ID to analyze"
        required: true
        type: string
      pr_number:
        description: "PR number associated with the failure"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write

jobs:
  auto-fix:
    # Auto-trigger: only on CI failure for PRs (not push-to-master)
    # Manual trigger: always runs (workflow_dispatch)
    # Guard: skip Claude's own branches to prevent infinite loops
    if: |
      github.event_name == 'workflow_dispatch' ||
      (
        github.event.workflow_run.conclusion == 'failure' &&
        github.event.workflow_run.pull_requests[0] &&
        !startsWith(github.event.workflow_run.head_branch, 'claude/') &&
        !startsWith(github.event.workflow_run.head_branch, 'claude-auto-fix-ci-')
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      CLAUDE_AUTH_PROVIDER: ${{ vars.CLAUDE_AUTH_PROVIDER || 'llmgw' }}
      LLMGW_ID: ${{ secrets.LLMGW_ID }}
      LLMGW_SECRET: ${{ secrets.LLMGW_SECRET }}
      LLMGW_TOKEN_URL: ${{ secrets.LLMGW_TOKEN_URL }}
      NV_INFERENCE_TOKEN: ${{ secrets.NV_INFERENCE_TOKEN }}

    concurrency:
      group: claude-ci-analysis-${{ github.event.workflow_run.pull_requests[0].number || github.event.inputs.pr_number || github.run_id }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get CI failure details
        id: failure_details
        uses: actions/github-script@v7
        with:
          script: |
            // Support both workflow_run (auto) and workflow_dispatch (manual) triggers
            const runId = context.eventName === 'workflow_dispatch'
              ? parseInt('${{ github.event.inputs.run_id }}')
              : ${{ github.event.workflow_run.id || 0 }};

            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            // Download logs from each failed job individually
            // Truncate to last 3000 chars per job to stay within prompt limits
            // (Slang CI can have up to 41 jobs — only failed ones are downloaded)
            const MAX_LOG_CHARS = 3000;
            let errorLogs = [];
            for (const job of failedJobs) {
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });
                const logText = typeof logs.data === 'string' ? logs.data : String(logs.data);
                const failedSteps = job.steps
                  .filter(s => s.conclusion === 'failure')
                  .map(s => s.name);
                errorLogs.push({
                  jobName: job.name,
                  jobId: job.id,
                  failedSteps: failedSteps,
                  logs: logText.length > MAX_LOG_CHARS
                    ? '...[truncated]\n' + logText.slice(-MAX_LOG_CHARS)
                    : logText
                });
              } catch (e) {
                errorLogs.push({
                  jobName: job.name,
                  jobId: job.id,
                  failedSteps: [],
                  logs: `Failed to download logs: ${e.message}`
                });
              }
            }

            // Get PR number from event or input
            const prNumber = context.eventName === 'workflow_dispatch'
              ? parseInt('${{ github.event.inputs.pr_number }}')
              : ${{ github.event.workflow_run.pull_requests[0].number || 0 }};

            core.setOutput('run_id', runId);
            core.setOutput('run_url', run.data.html_url);
            core.setOutput('pr_number', prNumber);
            core.setOutput('head_branch', run.data.head_branch);
            core.setOutput('failed_jobs', JSON.stringify(failedJobs.map(j => j.name)));
            core.setOutput('error_logs', JSON.stringify(errorLogs));

      - name: Setup git identity
        run: |
          git config --global user.email "claude[bot]@users.noreply.github.com"
          git config --global user.name "claude[bot]"

      - name: Checkout failing branch and create fix branch
        id: branch
        run: |
          git checkout ${{ steps.failure_details.outputs.head_branch }}
          BRANCH_NAME="claude-auto-fix-ci-${{ steps.failure_details.outputs.head_branch }}-${{ github.run_id }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Fix CI failures with Claude
        uses: ./.github/actions/claude-code-runner
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          show-debug-output: ${{ vars.SLANG_CLAUDE_DEBUG_ENV || 'false' }}
          max-turns: "500"
          prompt: |
            /fix-ci
            Failed CI Run: ${{ steps.failure_details.outputs.run_url }}
            Failed Jobs: ${{ steps.failure_details.outputs.failed_jobs }}
            PR Number: ${{ steps.failure_details.outputs.pr_number }}
            Fix Branch: ${{ steps.branch.outputs.branch_name }}
            Base Branch: ${{ steps.failure_details.outputs.head_branch }}
            Repository: ${{ github.repository }}

            Error logs from each failed job:
            ${{ steps.failure_details.outputs.error_logs }}

            Steps:
            1. Analyze the error logs above to identify the root cause of each failure
            2. If logs are truncated, download full logs with `gh run view ${{ steps.failure_details.outputs.run_id }} --log-failed`
               or for a specific job: `gh api repos/${{ github.repository }}/actions/jobs/{job_id}/logs`
            3. Check the PR diff with `gh pr diff ${{ steps.failure_details.outputs.pr_number }}` to understand the changes
            4. Fix the code — apply the necessary changes to resolve the CI failure
            5. Run `./extras/formatting.sh` if the failure is formatting-related
            6. Commit the fix on the current branch (${{ steps.branch.outputs.branch_name }})
            7. Push the fix branch
            8. Merge the fix branch back into the original PR branch:
               `git checkout ${{ steps.failure_details.outputs.head_branch }} && git merge ${{ steps.branch.outputs.branch_name }} && git push origin ${{ steps.failure_details.outputs.head_branch }}`
            9. Comment on PR #${{ steps.failure_details.outputs.pr_number }} explaining what was fixed and why

          custom-instructions: |
            ### **Environment**
            - This workflow runs on Linux (ubuntu-latest) — use `gh` (not `gh.exe`)
            - Do NOT use `curl` for GitHub API calls — use `gh` CLI instead
            - Build: `cmake --preset default`, then `cmake --build --preset release`

            ### **Slang CI Context**
            - Slang CI builds on multiple platforms (Windows, Linux, macOS) with up to 41 jobs
            - Common failures: compilation errors, test failures, SPIRV validation, formatting
            - Build uses CMake presets; tests run via slang-test
            - Check if failure is platform-specific or affects all platforms
            - Error logs are truncated — use `gh run view <run_id> --log-failed` for full logs
            - For individual job logs: `gh api repos/{owner}/{repo}/actions/jobs/{job_id}/logs`

            ### **Fix Guidelines**
            - Fix the root cause, not symptoms — apply minimal targeted changes
            - For formatting failures: run `./extras/formatting.sh` and commit
            - For compilation errors: fix the code and verify it builds
            - For test failures: fix the test or the code that broke it
            - Always commit fixes on the fix branch first, then merge back to the PR branch
            - Comment on the PR explaining the fix

          mcp-config: |
            {
              "mcpServers": {
                "deepwiki": {
                  "type": "http",
                  "url": "https://mcp.deepwiki.com/mcp"
                }
              }
            }

          allowed-tools: |
            View,GlobTool,GrepTool,BatchTool,Write,WebSearch,
            Bash(cmake*),
            Bash(./build/*slangc*),
            Bash(./build/*slang-test*),
            Bash(git *),
            Bash(grep *),Bash(grep -*),
            Bash(cat *),Bash(head *),Bash(tail *),
            Bash(ls *),Bash(find *),Bash(wc *),
            Bash(mkdir *),Bash(cp *),Bash(mv *),
            Bash(gh run *),
            Bash(gh pr *),
            Bash(gh issue *),
            Bash(gh api *),
            Bash(./extras/formatting.sh*),
            Bash(chmod *),
            mcp__deepwiki__ask_question,
            mcp__github__add_issue_comment,
            mcp__github_ci__get_ci_status,
            mcp__github_ci__get_workflow_run_details,
            mcp__github_ci__download_job_log
