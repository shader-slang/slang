name: Claude CI Failure Analysis

# Analyzes CI failures on PRs, fixes the code, and pushes the fix
# Triggers when the main CI workflow completes with failure
# Based on: claude-code-action/examples/ci-failure-auto-fix.yml
#
# Flow: CI fails on PR -> grab error logs -> create fix branch -> Claude fixes -> merge back to PR branch

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: "Failed CI workflow run ID to analyze"
        required: true
        type: string
      pr_number:
        description: "PR number associated with the failure"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write

jobs:
  auto-fix:
    # Auto-trigger: only on CI failure for PRs (not push-to-master)
    # Manual trigger: always runs (workflow_dispatch)
    # Guard: skip Claude's own branches to prevent infinite loops
    if: |
      github.event_name == 'workflow_dispatch' ||
      (
        github.event.workflow_run.conclusion == 'failure' &&
        github.event.workflow_run.pull_requests[0] &&
        !startsWith(github.event.workflow_run.head_branch, 'claude/') &&
        !startsWith(github.event.workflow_run.head_branch, 'claude-auto-fix-ci-')
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      CLAUDE_AUTH_PROVIDER: ${{ vars.CLAUDE_AUTH_PROVIDER || 'llmgw' }}
      LLMGW_ID: ${{ secrets.LLMGW_ID }}
      LLMGW_SECRET: ${{ secrets.LLMGW_SECRET }}
      LLMGW_TOKEN_URL: ${{ secrets.LLMGW_TOKEN_URL }}
      NV_INFERENCE_TOKEN: ${{ secrets.NV_INFERENCE_TOKEN }}

    concurrency:
      group: claude-ci-analysis-${{ github.event.workflow_run.pull_requests[0].number || github.event.inputs.pr_number || github.run_id }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get CI failure details
        id: failure_details
        uses: actions/github-script@v7
        with:
          script: |
            // Support both workflow_run (auto) and workflow_dispatch (manual) triggers
            const runId = context.eventName === 'workflow_dispatch'
              ? parseInt('${{ github.event.inputs.run_id }}')
              : ${{ github.event.workflow_run.id || 0 }};

            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            // Download logs from each failed job individually
            // Truncate to last 3000 chars per job to stay within prompt limits
            // (Slang CI can have up to 41 jobs — only failed ones are downloaded)
            const MAX_LOG_CHARS = 3000;
            let errorLogs = [];
            for (const job of failedJobs) {
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });
                const logText = typeof logs.data === 'string' ? logs.data : String(logs.data);
                const failedSteps = job.steps
                  .filter(s => s.conclusion === 'failure')
                  .map(s => s.name);
                errorLogs.push({
                  jobName: job.name,
                  jobId: job.id,
                  failedSteps: failedSteps,
                  logs: logText.length > MAX_LOG_CHARS
                    ? '...[truncated]\n' + logText.slice(-MAX_LOG_CHARS)
                    : logText
                });
              } catch (e) {
                errorLogs.push({
                  jobName: job.name,
                  jobId: job.id,
                  failedSteps: [],
                  logs: `Failed to download logs: ${e.message}`
                });
              }
            }

            // Get PR number from event or input
            const prNumber = context.eventName === 'workflow_dispatch'
              ? parseInt('${{ github.event.inputs.pr_number }}')
              : ${{ github.event.workflow_run.pull_requests[0].number || 0 }};

            core.setOutput('run_id', runId);
            core.setOutput('run_url', run.data.html_url);
            core.setOutput('pr_number', prNumber);
            core.setOutput('head_branch', run.data.head_branch);
            core.setOutput('failed_jobs', JSON.stringify(failedJobs.map(j => j.name)));
            core.setOutput('error_logs', JSON.stringify(errorLogs));

      - name: Setup git identity
        run: |
          git config --global user.email "claude[bot]@users.noreply.github.com"
          git config --global user.name "claude[bot]"

      - name: Checkout failing branch and create fix branch
        id: branch
        run: |
          git checkout ${{ steps.failure_details.outputs.head_branch }}
          BRANCH_NAME="claude-auto-fix-ci-${{ steps.failure_details.outputs.head_branch }}-${{ github.run_id }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Fix CI failures with Claude
        uses: ./.github/actions/claude-code-runner
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          show-debug-output: ${{ vars.SLANG_CLAUDE_DEBUG_ENV || 'false' }}
          max-turns: "500"
          prompt: |
            Failed CI Run: ${{ steps.failure_details.outputs.run_url }}
            Failed Jobs: ${{ steps.failure_details.outputs.failed_jobs }}
            PR Number: ${{ steps.failure_details.outputs.pr_number }}
            Fix Branch: ${{ steps.branch.outputs.branch_name }}
            Base Branch: ${{ steps.failure_details.outputs.head_branch }}
            Repository: ${{ github.repository }}
            Run ID: ${{ steps.failure_details.outputs.run_id }}

            Error logs from each failed job:
            ${{ steps.failure_details.outputs.error_logs }}

            ### Steps
            1. **Analyze**: Read the error logs above. If truncated, get full logs:
               `gh run view ${{ steps.failure_details.outputs.run_id }} --log-failed`
               For a specific job: `gh api repos/${{ github.repository }}/actions/jobs/{JOB_ID}/logs`
            2. **Understand the PR**: `gh pr diff ${{ steps.failure_details.outputs.pr_number }}`
            3. **Diagnose**: Determine if the failure is a compilation error, test failure, formatting issue,
               or platform-specific problem. Check if the same failure affects multiple jobs.
            4. **Fix**: Apply minimal, targeted changes to resolve the root cause.
               For formatting failures, just run `./extras/formatting.sh`.
            5. **Commit and push** on the current branch (${{ steps.branch.outputs.branch_name }})
            6. **Merge back**: Merge the fix into the original PR branch:
               ```
               git checkout ${{ steps.failure_details.outputs.head_branch }}
               git merge ${{ steps.branch.outputs.branch_name }}
               git push origin ${{ steps.failure_details.outputs.head_branch }}
               ```
            7. **Comment** on PR #${{ steps.failure_details.outputs.pr_number }} explaining what failed and why,
               what you fixed, and any remaining concerns.

          # Note: CLAUDE.md is auto-loaded and covers build commands, CLI conventions, and debugging.
          # These instructions cover ONLY CI-specific context and failure patterns.
          custom-instructions: |
            ### **Environment**
            - Linux (ubuntu-latest), no GPU — use `gh` CLI for ALL GitHub API calls, never `curl`

            ### **Slang CI Context**
            - CI runs up to 41 jobs across Windows, Linux, macOS with various GPU/API combinations
            - Check if failure is platform-specific (one job) or systemic (multiple jobs)

            ### **Common Failure Patterns**
            - **Formatting**: Run `./extras/formatting.sh` and commit. Often the only fix needed.
            - **Compilation errors**: Usually a missing include, type mismatch, or platform-specific API.
              Check if the error is Windows-only (MSVC) vs Linux (GCC/Clang) — they have different strictness.
            - **Test failures**: Compare expected vs actual output. Check if a test directive uses a
              GPU API unavailable on the failing platform.
            - **SPIRV validation**: Set `SLANG_RUN_SPIRV_VALIDATION=1` to reproduce locally with slangc.
            - **Linker errors**: Often caused by missing FIDDLE annotations or new files not added to CMakeLists.txt.

            ### **Fix Guidelines**
            - Fix the root cause with minimal targeted changes — don't refactor surrounding code
            - Always commit on the fix branch first, then merge back to the PR branch
            - Comment on the PR explaining what failed, why, and what you changed

          mcp-config: |
            {
              "mcpServers": {
                "deepwiki": {
                  "type": "http",
                  "url": "https://mcp.deepwiki.com/mcp"
                }
              }
            }

          allowed-tools: |
            View,Edit,GlobTool,GrepTool,BatchTool,Write,WebSearch,
            Bash(cmake*),
            Bash(./build/*slangc*),
            Bash(./build/*slang-test*),
            Bash(git *),
            Bash(grep *),Bash(grep -*),
            Bash(cat *),Bash(head *),Bash(tail *),
            Bash(ls *),Bash(find *),Bash(wc *),
            Bash(mkdir *),Bash(cp *),Bash(mv *),
            Bash(gh run *),
            Bash(gh pr *),
            Bash(gh issue *),
            Bash(gh api *),
            Bash(./extras/formatting.sh*),
            Bash(chmod *),
            mcp__deepwiki__ask_question,
            mcp__github__add_issue_comment,
            mcp__github__get_pull_request,
            mcp__github__get_pull_request_diff,
            mcp__github__get_pull_request_files,
            mcp__github_ci__get_ci_status,
            mcp__github_ci__get_workflow_run_details,
            mcp__github_ci__download_job_log
