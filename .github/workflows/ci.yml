name: CI

on:
  workflow_dispatch:
  merge_group:
    types: [checks_requested]
  pull_request:
    branches: [master]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name != 'push' }}
jobs:
  # TEMP: Only run Linux GPU tests for faster iteration
  # Linux GPU builds (container-based CUDA builds on GitHub-hosted runners)
  build-linux-release-gcc-x86_64-gpu:
    uses: ./.github/workflows/ci-slang-build-cuda.yml
    with:
      config: release
      runs-on: '["ubuntu-22.04"]'

  # Linux GPU tests (self-hosted runner with NVIDIA GPU, containerized)
  test-linux-release-gcc-x86_64-gpu:
    needs: [build-linux-release-gcc-x86_64-gpu]
    uses: ./.github/workflows/ci-slang-test-cuda.yml
    with:
      config: release
      server-count: 4
