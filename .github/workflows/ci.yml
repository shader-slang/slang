name: CI

on:
  workflow_dispatch:
  merge_group:
    types: [checks_requested]
  pull_request:
    branches: [master]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name != 'push' }}
jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.filter.outputs.should-run }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: "2"
      - id: filter
        run: |
          # This step prevents subsequent steps from running if only documentation was changed
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git fetch origin ${{ github.base_ref }}
            BASE=origin/${{ github.base_ref }}
          else
            BASE=HEAD^1
          fi

          shouldRun=true
          if files="$(git diff --name-only $BASE...HEAD)"; then
            # Git diff succeeded, check if non-documentation files were changed
            if echo "$files" | grep -qvE '^(docs/|LICENSES/|LICENSE$|CONTRIBUTING\.md$|README\.md$)'; then
              shouldRun=true
            else
              echo "Only documentation files changed, skipping remaining steps"
              shouldRun=false
            fi
          else
            echo "Git diff failed, conservatively running tests"
            shouldRun=true
          fi
          echo "should-run=$shouldRun" >> $GITHUB_OUTPUT

  # Windows builds (self-hosted)
  build-windows-debug-cl-x86_64-gpu:
    needs: [filter]
    if: needs.filter.outputs.should-run == 'true'
    uses: ./.github/workflows/ci-slang-build.yml
    with:
      os: windows
      compiler: cl
      platform: x86_64
      config: debug
      runs-on: '["Windows", "self-hosted", "test"]'
