name: VK-GL-CTS Nightly

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
env:
  DISABLE_CTS_SLANG: 0
  ACTIONS_RUNNER_DEBUG: true
  ACTIONS_STEP_DEBUG: true
jobs:
  build:
    strategy:
      matrix:
        include:
          # Self-hosted falcor tests
          - os: windows
            compiler: cl
            platform: x86_64
            config: release
            warnings-as-errors: true
            test-category: full
            full-gpu-tests: false
            runs-on: [Windows, self-hosted, GCP-T4]
    runs-on: ${{ matrix.runs-on }}
    timeout-minutes: 180
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: "true"
          fetch-depth: "0"
      - name: Setup
        uses: ./.github/actions/common-setup
        with:
          os: ${{matrix.os}}
          compiler: ${{matrix.compiler}}
          platform: ${{matrix.platform}}
          config: ${{matrix.config}}
          build-llvm: true
      - name: Build Slang
        run: |
          cmake --preset default --fresh \
            -DCMAKE_COMPILE_WARNING_AS_ERROR=${{matrix.warnings-as-errors}} \

            #-DSLANG_SLANG_LLVM_FLAVOR=DISABLE \
            #-DSLANG_ENABLE_CUDA=0 \
            #-DSLANG_ENABLE_DXIL=0 \
            #-DSLANG_ENABLE_EXAMPLES=0 \
            #-DSLANG_ENABLE_GFX=0 \
            #-DSLANG_ENABLE_REPLAYER=0 \
            #-DSLANG_ENABLE_SLANGC=0 \
            #-DSLANG_ENABLE_SLANGD=0 \
            #-DSLANG_ENABLE_SLANGRT=0 \
            #-DSLANG_ENABLE_TESTS=0 \
            #-DSLANG_EXCLUDE_DAWN=1 \
            #-DSLANG_EXCLUDE_TINT=1
          cmake --workflow --preset "${{matrix.config}}"
      - name: Test Slang
        run: |
          export SLANG_RUN_SPIRV_VALIDATION=1
          export SLANG_USE_SPV_SOURCE_LANGUAGE_UNKNOWN=1
          "build/Release/bin/slang-test" \
            -show-adapter-info \
            tests/compute/frem.slang
      - uses: robinraju/release-downloader@v1.11
        with:
          latest: true
          repository: "shader-slang/VK-GL-CTS"
          fileName: "VK-GL-CTS_WithSlang-0.0.7-win64.zip"
      - uses: actions/checkout@v4
        with:
          repository: "shader-slang/VK-GL-CTS"
          sparse-checkout: |
            test-lists/slang-passing-tests.txt
            test-lists/slang-waiver-tests.xml
          path: test-lists
          sparse-checkout-cone-mode: false
      - name: vkcts setup
        shell: pwsh
        run: |
          Expand-Archive VK-GL-CTS_WithSlang-0.0.7-win64.zip

          copy ${{ github.workspace }}\build\Release\bin\slang.dll ${{ github.workspace }}\VK-GL-CTS_WithSlang-0.0.7-win64\slang.dll
          copy ${{ github.workspace }}\build\Release\bin\slang-glslang.dll ${{ github.workspace }}\VK-GL-CTS_WithSlang-0.0.7-win64\slang-glslang.dll
          copy ${{ github.workspace }}\build\Release\bin\slang-glsl-module.dll ${{ github.workspace }}\VK-GL-CTS_WithSlang-0.0.7-win64\slang-glsl-module.dll
          copy ${{ github.workspace }}\build\Release\bin\test-server.exe ${{ github.workspace }}\VK-GL-CTS_WithSlang-0.0.7-win64\test-server.exe

          copy ${{ github.workspace }}\test-lists\test-lists\slang-passing-tests.txt ${{ github.workspace }}\VK-GL-CTS_WithSlang-0.0.7-win64\slang-passing-tests.txt
          copy ${{ github.workspace }}\test-lists\test-lists\slang-waiver-tests.xml ${{ github.workspace }}\VK-GL-CTS_WithSlang-0.0.7-win64\slang-waiver-tests.xml

      - name: dump device info
        working-directory: ${{ github.workspace }}\VK-GL-CTS_WithSlang-0.0.7-win64
        run: |
          ./deqp-vk.exe --deqp-case=dEQP-VK.info.device
          cat TestResults.qpa

      - name: vkcts run
        shell: pwsh
        working-directory: ${{ github.workspace }}\VK-GL-CTS_WithSlang-0.0.7-win64
        run: |
          $env:DISABLE_CTS_SLANG_SERVER_MODE = "1"
          .\deqp-vk.exe --deqp-archive-dir=${{ github.workspace }}\VK-GL-CTS_WithSlang-0.0.7-win64 --deqp-caselist-file=${{ github.workspace }}\VK-GL-CTS_WithSlang-0.0.7-win64\slang-passing-tests.txt --deqp-waiver-file=${{ github.workspace }}\VK-GL-CTS_WithSlang-0.0.7-win64\slang-waiver-tests.xml

      - name: Dump TestResults.qpa if failed
        if: ${{ !success() }}
        working-directory: ${{ github.workspace }}\VK-GL-CTS_WithSlang-0.0.7-win64
        run: tail -1000 TestResults.qpa

      - name: success notification
        id: slack-notify-success
        if: ${{ success() }}
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "CTS-Nightly": ":green-check-mark: CTS nightly status: ${{ job.status }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      - name: failure notification
        id: slack-notify-failure
        if: ${{ !success() }}
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "CTS-Nightly": ":alert: :alert: :alert: :alert: :alert: :alert:\nCTS nightly status: ${{ job.status }}: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
