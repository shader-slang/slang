name: ClaudeCode - Slang Assistant

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Direct prompt for Claude (agent mode testing)"
        required: false
        type: string
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned, labeled]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [labeled]

jobs:
  claude:
    name: Claude Code Assistant
    # Intelligent mode detection: The action auto-detects @claude mentions.
    # We only need explicit conditions for non-standard triggers (workflow_dispatch, labels, assignee).
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && github.event.action == 'assigned' && github.event.assignee.login == 'claude') ||
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'claude') ||
      (github.event_name == 'pull_request' && github.event.action == 'labeled' && github.event.label.name == 'claude') ||
      contains(github.event.comment.body || github.event.review.body || github.event.issue.body || '', '@claude')

    runs-on: ${{ fromJSON(vars.CLAUDE_RUNNER || '["Windows", "self-hosted", "GCP-T4"]') }}
    timeout-minutes: 360

    # Centralized auth configuration via environment variables
    env:
      CLAUDE_AUTH_PROVIDER: ${{ vars.CLAUDE_AUTH_PROVIDER || 'llmgw' }}
      LLMGW_ID: ${{ secrets.LLMGW_ID }}
      LLMGW_SECRET: ${{ secrets.LLMGW_SECRET }}
      LLMGW_TOKEN_URL: ${{ secrets.LLMGW_TOKEN_URL }}
      NV_INFERENCE_TOKEN: ${{ secrets.NV_INFERENCE_TOKEN }}

    concurrency:
      group: claude-${{ github.event.issue.number || github.event.pull_request.number || github.run_id }}
      cancel-in-progress: true

    steps:
      # Windows-specific setup: Add bash to PATH (must be before any bash steps)
      - name: Add bash to PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Add-Content -Path $env:GITHUB_PATH -Value "C:\Program Files\Git\bin"
          Add-Content -Path $env:GITHUB_PATH -Value "C:\Program Files\Git\usr\bin"

      # Install jq on Windows (not pre-installed on self-hosted runners)
      # Creates wrappers for both cmd.exe and bash compatibility
      # See: https://github.com/anthropics/claude-code-action/issues/712
      - name: Install jq (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $toolsDir = "C:\Windows\ServiceProfiles\NetworkService\.local\bin"
          New-Item -ItemType Directory -Force -Path $toolsDir | Out-Null

          # Download jq
          $jqUrl = "https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-win64.exe"
          $jqExe = "$env:RUNNER_TEMP\jq-windows.exe"
          Invoke-WebRequest -Uri $jqUrl -OutFile $jqExe

          # Convert to Unix path for bash wrapper
          $jqExeUnix = $jqExe -replace '\\', '/' -replace '^([A-Za-z]):', '/$1'

          # Create jq.cmd wrapper that routes through bash for proper quoting
          $cmdWrapper = "$toolsDir\jq.cmd"
          $wrapperContent = "@echo off`r`n`"C:\Program Files\Git\bin\bash.exe`" -c '`"$jqExeUnix`" `"`$@`"' _ %*"
          Set-Content -Path $cmdWrapper -Value $wrapperContent -Encoding ASCII

          # Create jq bash script (no extension) for Git Bash compatibility
          $bashWrapper = "$toolsDir\jq"
          $bashContent = "#!/bin/bash`n`"$jqExeUnix`" `"`$@`""
          Set-Content -Path $bashWrapper -Value $bashContent -NoNewline -Encoding ASCII

          Write-Host "jq wrappers installed at $toolsDir"

          # Add tools directory to PATH
          Add-Content -Path $env:GITHUB_PATH -Value $toolsDir

      # Install Claude Code on Windows (the action's install.sh doesn't support Windows)
      - name: Install Claude Code (Windows)
        id: install-claude
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Installing Claude Code on Windows..."
          irm https://claude.ai/install.ps1 | iex

          # Search for claude.exe in likely locations
          Write-Host "Searching for claude.exe..."

          $searchPaths = @(
            "$env:USERPROFILE\.local\bin",
            "$env:USERPROFILE\.claude",
            "C:\Windows\ServiceProfiles\NetworkService\.local\bin",
            "$env:LOCALAPPDATA\Claude",
            "$env:LOCALAPPDATA\Programs\Claude",
            "$env:APPDATA\Claude",
            "$env:PROGRAMFILES\Claude",
            "${env:PROGRAMFILES(x86)}\Claude"
          )

          # Debug: List contents of .claude directory if it exists
          if (Test-Path "$env:USERPROFILE\.claude") {
            Write-Host "Contents of $env:USERPROFILE\.claude:"
            Get-ChildItem -Path "$env:USERPROFILE\.claude" -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
          }

          # Search for claude.exe
          $claudeExe = $null
          foreach ($searchPath in $searchPaths) {
            if (Test-Path $searchPath) {
              $found = Get-ChildItem -Path $searchPath -Filter "claude.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) {
                $claudeExe = $found.FullName
                break
              }
            }
          }

          if ($claudeExe) {
            Write-Host "Claude Code found at: $claudeExe"
            echo "claude-exe-path=$claudeExe" >> $env:GITHUB_OUTPUT
            # Add directory to PATH
            $claudeDir = Split-Path $claudeExe -Parent
            Add-Content -Path $env:GITHUB_PATH -Value $claudeDir
          } else {
            Write-Host "::error::Claude Code executable not found after installation"
            Write-Host "Searched paths: $($searchPaths -join ', ')"
            exit 1
          }

      # Format setup and environment preparation
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Checkout of submodules
        run: git submodule update --init --recursive --depth=1

      - name: Format Setup and Environment Preparation
        if: runner.os != 'Windows'
        continue-on-error: true
        uses: ./.github/actions/format-setup

      # Complete Claude execution with authentication, setup, and execution
      - name: Run Claude Code
        id: claude
        uses: ./.github/actions/claude-code-runner
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          prompt: ${{ github.event.inputs.prompt || '' }}
          show-debug-output: ${{ vars.SLANG_CLAUDE_DEBUG_ENV || 'false' }}

          # Path to pre-installed Claude Code executable (Windows only)
          claude-code-executable-path: ${{ steps.install-claude.outputs.claude-exe-path || '' }}

          # Repository-specific setup (auto-detects Windows vs Linux)
          # Build is skipped for review events (pull_request_review, pull_request_review_comment)
          # where Claude only needs to read code. Claude can build on-demand via cmake if needed.
          setup-commands: |
            set -euo pipefail
            EVENT_NAME="${GITHUB_EVENT_NAME:-}"
            if [ "$EVENT_NAME" = "pull_request_review" ] || [ "$EVENT_NAME" = "pull_request_review_comment" ]; then
              echo "Review event detected ($EVENT_NAME) â€” skipping build."
              echo "Claude can build on-demand if needed via cmake commands."
            elif [ "${RUNNER_OS}" = "Windows" ]; then
              echo "Setting up Windows environment..."
              cmake.exe --preset vs2022 --fresh
              cmake.exe --build --preset release >/dev/null 2>&1 || cmake.exe --build --preset release
            else
              echo "Setting up Linux environment..."
              cmake --preset default -DSLANG_SLANG_LLVM_BINARY_URL=https://github.com/shader-slang/slang/releases/download/v2025.6.1/slang-2026.1.2-linux-x86_64.zip --fresh
              cmake --build --preset release >/dev/null 2>&1 || cmake --build --preset release
            fi
            echo "Environment setup completed"

          # Custom instructions for Slang
          custom-instructions: |
            ### **Environment**
            Check `RUNNER_OS` to determine platform capabilities:

            **Windows (self-hosted, GPU):**
            - OS: Windows Server 2022 with NVIDIA T4 GPU
            - Build: `cmake.exe --preset vs2022`, then `cmake.exe --build --preset release`
            - Test: `./build/Release/bin/slang-test.exe tests/path/to/test.slang`
            - GPU tests: Use `-api dx12` or `-api vk` flags for D3D12/Vulkan
            - Use `cmake.exe` (not `cmake`) on Windows

            **Linux (GitHub-hosted, no GPU):**
            - Build: `cmake --preset default`, then `cmake --build --preset release`
            - Test: `./build/Release/bin/slang-test tests/path/to/test.slang`
            - CPU/interpreter tests only (`-cpu` or `INTERPRET` mode)
            - No GPU tests (D3D12, Vulkan, Metal, WGSL unavailable)

            ### **Repository Knowledge**
            Use `mcp__deepwiki__ask_question` with repoName "shader-slang/slang" when you need deep
            understanding of Slang's architecture, IR system, compilation pipeline, or code patterns.
            Read CLAUDE.md in the repo root for build, test, and debugging guidance.

            ### **Capabilities**
            - Read, analyze, write, and modify source code
            - Build and test the project (GPU tests on Windows only)
            - Create branches, commit changes, push, and manage PRs via `gh`
            - Review PRs with inline comments via MCP tools
            - Search code, check git history, analyze patterns
            - Run `./extras/formatting.sh` before committing changes

            ### **Conditional Build**
            For review events (pull_request_review, pull_request_review_comment), the project
            is NOT pre-built to save time. If you need to compile or run tests, build first:
            - Windows: `cmake.exe --preset vs2022 --fresh && cmake.exe --build --preset release`
            - Linux: `cmake --preset default && cmake --build --preset release`

            ### **Test-Driven Development**
            Write failing tests in `tests/` directory, implement fixes, and verify both
            tests and builds succeed before submitting. On Linux, use CPU or INTERPRET mode.

          # MCP configuration for deepwiki
          mcp-config: |
            {
              "mcpServers": {
                "deepwiki": {
                  "type": "http",
                  "url": "https://mcp.deepwiki.com/mcp"
                }
              }
            }

          # Advanced configuration (override action defaults via repository variables)
          model: ${{ vars.ANTHROPIC_MODEL }}
          aws-region: ${{ vars.AWS_REGION }}
          bedrock-base-url: ${{ vars.ANTHROPIC_BEDROCK_BASE_URL }}
          small-fast-model: ${{ vars.ANTHROPIC_SMALL_FAST_MODEL }}

          # Tool allowlist with granular Bash permissions for security
          # - Build commands: cmake, slang-test
          # - Git operations: git status/diff/log/add/commit/show
          # - GitHub CLI: gh pr/issue/run operations
          # - Slang-specific: slangc for testing compilation, formatting
          # - GitHub MCP: issues, PRs, inline comments, CI status/logs
          # - DeepWiki MCP: codebase understanding
          # - Web search for external references
          allowed-tools: |
            View,GlobTool,GrepTool,BatchTool,Write,WebSearch,
            Bash(cmake*),Bash(cmake.exe*),
            Bash(./build/*slangc*),
            Bash(./build/*slang-test*),
            Bash(git *),
            Bash(grep *),Bash(grep -*),
            Bash(cat *),Bash(head *),Bash(tail *),
            Bash(ls *),Bash(find *),Bash(wc *),
            Bash(mkdir *),Bash(cp *),Bash(mv *),
            Bash(gh pr *),
            Bash(gh issue *),
            Bash(gh run *),
            Bash(gh api *),
            Bash(./extras/formatting.sh*),
            Bash(python*extras/split-ir-dump.py*),
            Bash(python*extras/insttrace.py*),
            mcp__github_inline_comment__create_inline_comment,
            mcp__github__get_issue,
            mcp__github__get_issue_comments,
            mcp__github__add_issue_comment,
            mcp__github__list_issues,
            mcp__github__search_issues,
            mcp__github__create_pull_request,
            mcp__github__get_pull_request_diff,
            mcp__github__add_pull_request_review_comment,
            mcp__github_file_ops__commit_files,
            mcp__github_ci__get_ci_status,
            mcp__github_ci__get_workflow_run_details,
            mcp__github_ci__download_job_log,
            mcp__deepwiki__ask_question
