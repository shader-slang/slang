name: Claude PR Review

# Automated PR review for the Slang compiler
# Triggers on PRs to master that touch core source, tests, build, or tools

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to review"
        required: true
        type: number
  pull_request:
    branches: [master]
    types: [opened, synchronize, ready_for_review, reopened]
    paths:
      - "source/**"
      - "tests/**"
      - "prelude/**"
      - "include/**"
      - "tools/**"
      - "CMakeLists.txt"
      - "cmake/**"

permissions:
  contents: read
  pull-requests: write
  actions: read
  issues: write
  id-token: write

jobs:
  review:
    # Skip draft PRs, bot PRs, fork PRs, and Claude's own branches (loop prevention)
    # Fork PRs are skipped because GitHub does not expose secrets to fork PR workflows.
    # Use workflow_dispatch with pr_number to review fork PRs manually.
    # workflow_dispatch bypasses these checks (manual trigger = intentional)
    if: |
      github.event_name == 'workflow_dispatch' || (
        github.event.pull_request.draft == false &&
        !contains(github.event.pull_request.user.login, '[bot]') &&
        !startsWith(github.event.pull_request.head.ref, 'claude/') &&
        github.event.pull_request.head.repo.full_name == github.repository
      )
    runs-on: ubuntu-latest
    timeout-minutes: 60

    # Centralized auth configuration
    env:
      CLAUDE_AUTH_PROVIDER: ${{ vars.CLAUDE_AUTH_PROVIDER || 'llmgw' }}
      LLMGW_ID: ${{ secrets.LLMGW_ID }}
      LLMGW_SECRET: ${{ secrets.LLMGW_SECRET }}
      LLMGW_TOKEN_URL: ${{ secrets.LLMGW_TOKEN_URL }}
      NV_INFERENCE_TOKEN: ${{ secrets.NV_INFERENCE_TOKEN }}

    concurrency:
      group: claude-review-${{ github.event.inputs.pr_number || github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: PR Review with Progress Tracking
        uses: ./.github/actions/claude-code-runner
        with:
          show-debug-output: ${{ (vars.SLANG_CLAUDE_DEBUG_ENV == '1' || vars.SLANG_CLAUDE_DEBUG_ENV == 'true') && 'true' || 'false' }}
          nv-inference-opus-model: ${{ vars.CLAUDE_NV_OPUS_MODEL }}
          nv-inference-sonnet-model: ${{ vars.CLAUDE_NV_SONNET_MODEL }}
          nv-inference-haiku-model: ${{ vars.CLAUDE_NV_HAIKU_MODEL }}
          max-turns: "500"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.inputs.pr_number || github.event.pull_request.number }}

            Review this PR for the Slang shader compiler. Read CLAUDE.md for compiler architecture context.
            IMPORTANT: The repo is checked out locally. Use View/GlobTool/GrepTool for file reads and `gh pr diff` for the diff. Use MCP tools and `gh pr view` for PR metadata.
            ### How to review
            1. Fetch the PR diff with `gh pr diff <number>` and the changed files list
            2. Read each changed file IN FULL in the repository (not just the diff) to understand context
            3. Create a PENDING review with mcp__github__create_pending_pull_request_review
            4. Add inline comments using mcp__github__add_comment_to_pending_review for every bug,
               issue, suggestion, or non-trivial observation. Aim for at least one inline comment per
               changed file when there is something worth noting. Do NOT use inline comments for praise.
            5. Submit the review with mcp__github__submit_pending_pull_request_review with event "COMMENT",
               including a summary with overall assessment, positive feedback, and key findings.
            6. ALWAYS post a PR comment via mcp__github__add_issue_comment summarizing what the PR does,
               key findings, and verdict. This ensures notification even if the review submission fails.

            Inline comments are the most valuable part. Be specific and line-level, not vague.

          # Note: CLAUDE.md is auto-loaded and covers compiler pipeline, IR system, CLI conventions, etc.
          # These instructions cover ONLY review-specific priorities and patterns.
          custom-instructions: |
            ### **Review Priorities**
            - IR pass changes: verify SSA form and type invariants are maintained
            - Emit changes: all target backends (SPIRV, HLSL, GLSL, Metal, CUDA, WGSL) should be consistent;
              emit logic should be simple — flag complex transforms that belong in IR passes
            - Semantic check changes (slang-check-*.cpp): verify overload resolution and type coercion
            - New IR instructions: must be in slang-ir-insts.lua with proper FIDDLE annotations
            - Public API changes (include/slang.h): flag as potentially ABI-breaking, need "pr: breaking" label
            - Test coverage: bug fixes need regression tests; non-GPU features use CPU or INTERPRET mode

            ### **Common Patterns to Flag**
            - Unchecked `as<T>()` casts on IRInst* (should check for null or use dynamicCast)
            - Missing cases in switch statements over IROp enums
            - IR passes that modify instructions without updating uses/users correctly
            - Emit code doing complex transforms instead of delegating to IR passes
            - Missing `break` or `return` in exhaustive IROp switches

          mcp-config: |
            {
              "mcpServers": {
                "deepwiki": {
                  "type": "http",
                  "url": "https://mcp.deepwiki.com/mcp"
                }
              }
            }

          # Security: read-only Bash (git, gh), write access only via specific MCP tools.
          # No PR approval capability — review is submitted as "COMMENT" only.
          # Note: Bash glob '*' does NOT match newlines, so multi-line commands are blocked.
          # Use MCP tools (add_issue_comment) for multi-line content like review summaries.
          allowed-tools: |
            View,GlobTool,GrepTool,BatchTool,
            Bash(git diff*),Bash(git log*),Bash(git show*),Bash(git status*),
            Bash(grep *),Bash(grep -*),
            Bash(cat *),Bash(head *),Bash(tail *),
            Bash(ls *),Bash(find *),Bash(wc *),
            Bash(gh pr diff*),Bash(gh pr view*),Bash(gh pr list*),Bash(gh pr checks*),
            mcp__github__get_pull_request,
            mcp__github__get_pull_request_files,
            mcp__github__get_pull_request_reviews,
            mcp__github__get_pull_request_status,
            mcp__github__get_issue,
            mcp__github__get_issue_comments,
            mcp__github__create_pending_pull_request_review,
            mcp__github__add_comment_to_pending_review,
            mcp__github__delete_pending_pull_request_review,
            mcp__github__submit_pending_pull_request_review,
            mcp__github__add_issue_comment,
            mcp__deepwiki__ask_question
