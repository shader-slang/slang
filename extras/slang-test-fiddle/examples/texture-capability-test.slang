// texture-capability-test.slang
// Example: Generate texture capability tests for different backends
//
// This demonstrates a complex test generation scenario similar to
// extras/generate-tests-capabilities-for-texture-types.py
//
// Generates to: <output-dir>/texture-capabilities/

#if 0 // FIDDLE TEMPLATE:
%-- Backend configuration
%local backends = {
%    {
%        name = "metal",
%        versions = {
%            {ver="2.3", target="metal -profile metallib_2_3", runtime="-mtl"},
%            {ver="2.4", target="metal -profile metallib_2_4", runtime="-mtl"}
%        }
%    }
%}
%
%-- Texture types with test operations
%local textureTests = {
%    {
%        type = "Texture2D<float4>",
%        testInput = "Texture2D(size=4, content = zero)",
%        minVersion = "2.3",
%        testOp = "int((texHandle.Load(int3(0, 0, 0))).x)"
%    },
%    {
%        type = "RWTexture2D<float4>",
%        testInput = "RWTexture2D(size=4, content = zero)",
%        minVersion = "2.3",
%        testOp = "int((texHandle.Load(int2(0, 0))).x)"
%    },
%    {
%        type = "Texture3D<float4>",
%        testInput = "Texture3D(size=4, content = zero)",
%        minVersion = "2.3",
%        testOp = "int((texHandle.Load(int4(0, 0, 0, 0))).x)"
%    }
%}
%
%-- Generate tests for each backend and texture type
%for _, backend in ipairs(backends) do
%    for _, test in ipairs(textureTests) do
%        -- Extract to locals for $splicing
%        local backendName = backend.name
%        local textureType = test.type
%        local testInput = test.testInput
%        local minVersion = test.minVersion
%        local testOp = test.testOp
%
%        -- Sanitize type name for filename (remove <>)
%        local cleanType = string.lower(string.gsub(textureType, "[<>]", ""):gsub("float4", "float4"):gsub(" ", "-"))
%
%        -- Find the version for testing
%        local testVersion = nil
%        local testTarget = nil
%        local testRuntime = nil
%        for _, ver in ipairs(backend.versions) do
%            if ver.ver == minVersion then
%                testVersion = ver.ver
%                testTarget = ver.target
%                testRuntime = ver.runtime
%                break
%            end
%        end
// THIS IS A GENERATED FILE. DO NOT EDIT!
// Generated by FIDDLE template: texture-capability-test.slang
//
// Texture types capability test: $backendName / $textureType
// - Type supported since target version: $minVersion

//TEST:SIMPLE(filecheck=POSITIVE): -entry fragMain -stage fragment -target $testTarget
//TEST(compute):COMPARE_COMPUTE(filecheck-buffer=POSITIVE_RESULT): $testRuntime

//TEST_INPUT: ubuffer(data=[0], stride=4):out,name outputBuffer
RWStructuredBuffer<int> outputBuffer;

//TEST_INPUT: $testInput:name texHandle
$textureType texHandle;

[shader("fragment")]
void fragMain()
{
// POSITIVE-NOT: {{(error|warning).*}}:
// POSITIVE: result code = 0
// POSITIVE-NOT: {{(error|warning).*}}:
// POSITIVE-LABEL: fragMain
// POSITIVE-NOT: {{(error|warning).*}}:

    int ret = 0;
    ret = $testOp;
    outputBuffer[0] = 0x12345 + ret;
}

[numthreads(4, 1, 1)]
void computeMain()
{
    int ret = 0;
    ret = $testOp;
    outputBuffer[0] = 0x12345 + ret;
}
// POSITIVE_RESULT: 12345
%        emit_test_file("texture-capabilities/gen-" .. backendName .. "-" .. cleanType .. ".slang")
%    end
%end
#else // FIDDLE OUTPUT:
#endif // FIDDLE END